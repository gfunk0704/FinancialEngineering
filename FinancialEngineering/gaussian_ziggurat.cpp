#include <gaussian_ziggurat.h>

namespace FinancialEngineering
{
    static const Real tail_thredshold = 3.442619855899;
    static const Real ziggurat_x[] = { 3.7130862467425505, 3.4426198558990002, 3.2230849845811416, 3.0832288582168683, 2.9786962526477803, 2.8943440070215289,
                                       2.8231253505489105, 2.7611693723871769, 2.7061135731218195, 2.6564064112613597, 2.6109722484318474, 2.5690336259249378,
                                       2.5300096723888275, 2.4934545220953721, 2.4590181774118305, 2.4264206455337498, 2.3954342780110625, 2.3658713701176386,
                                       2.3375752413392368, 2.3104136836987630, 2.2842740596774718, 2.2590595738691985, 2.2346863955909795, 2.2110814088787034,
                                       2.1881804320760492, 2.1659267937489219, 2.1442701823603953, 2.1231657086739766, 2.1025731351892385, 2.0824562379920168,
                                       2.0627822745083084, 2.0435215366550676, 2.0246469733773855, 2.0061338699634721, 1.9879595741276199, 1.9701032608543265,
                                       1.9525457295535567, 1.9352692282966228, 1.9182573008645099, 1.9014946531051511, 1.8849670357077590, 1.8686611409944887,
                                       1.8525645117280911, 1.8366654602584460, 1.8209529965961255, 1.8054167642192285, 1.7900469825998586, 1.7748343955860695,
                                       1.7597702248995934, 1.7448461281138004, 1.7300541605637305, 1.7153867407136676, 1.7008366185699169, 1.6863968467791681,
                                       1.6720607540976009, 1.6578219209540241, 1.6436741568628686, 1.6296114794706347, 1.6156280950431610, 1.6017183802213781,
                                       1.5878768648905761, 1.5740982160230008, 1.5603772223661689, 1.5467087798599104, 1.5330878776740433, 1.5195095847659401,
                                       1.5059690368632033, 1.4924614237813540, 1.4789819769899242, 1.4655259573427108, 1.4520886428892246, 1.4386653166845635,
                                       1.4252512545140601, 1.4118417124470577, 1.3984319141310053, 1.3850170377326518, 1.3715922024273426, 1.3581524543301435,
                                       1.3446927517535470, 1.3312079496656273, 1.3176927832094141, 1.3041418501286168, 1.2905495919261964, 1.2769102735601556,
                                       1.2632179614546211, 1.2494664995730682, 1.2356494832633627, 1.2217602305399964, 1.2077917504159497, 1.1937367078331287,
                                       1.1795873846639882, 1.1653356361647524, 1.1509728421488674, 1.1364898520131608, 1.1218769225825422, 1.1071236475340360,
                                       1.0922188769072774, 1.0771506248928957, 1.0619059636948243, 1.0464709007640454, 1.0308302360681956, 1.0149673952513305,
                                       0.9988642334929836, 0.9825008035154290, 0.9658550794011499, 0.9489026255113064, 0.9316161966151508, 0.9139652510230323,
                                       0.8959153525809377, 0.8774274291129234, 0.8584568431938132, 0.8389522142975774, 0.8188539067003573, 0.7980920606440569,
                                       0.7765839878947599, 0.7542306644540556, 0.7309119106424888, 0.7064796113354365, 0.6807479186691546, 0.6534786387399752,
                                       0.6243585973360507, 0.5929629424714483, 0.5586921784081852, 0.5206560387620606, 0.4774378372966898, 0.4265479863554235,
                                       0.3628714310970320, 0.2723208648139647, 0.0000000000000000 };

    static const Real ziggurat_r[] = { 0.9271586026096681, 0.9362302895738892, 0.9566079929529229, 0.9660963845448882, 0.9716814879827810, 0.9753938521821022,
                                       0.9780541171685178, 0.9800606946404889, 0.9816315315239645, 0.9828963811271866, 0.9839375456663325, 0.9848098704733534,
                                       0.9855513792328944, 0.9861893030819736, 0.9867436799867864, 0.9872295978111943, 0.9876586437103296, 0.9880398701570176,
                                       0.9883804563121089, 0.9886861715693078, 0.9889617072428545, 0.9892109183130244, 0.9894370025436909, 0.9896426351781105,
                                       0.9898300715969688, 0.9900012265183524, 0.9901577357834697, 0.9903010050508025, 0.9904322485336944, 0.9905525200843218,
                                       0.9906627383358567, 0.9907637071892196, 0.9908561326209719, 0.9909406365607181, 0.9910177684165790, 0.9910880146997187,
                                       0.9911518071021650, 0.9912095293081850, 0.9912615227624552, 0.9913080915739614, 0.9913495066999154, 0.9913860095266759,
                                       0.9914178149430195, 0.9914451139838447, 0.9914680761085329, 0.9914868511670121, 0.9915015710974835, 0.9915123513923666,
                                       0.9915192923629307, 0.9915224802280646, 0.9915219880484646, 0.9915178765240442, 0.9915101946694387, 0.9914989803800052,
                                       0.9914842608986051, 0.9914660531916395, 0.9914443642412228, 0.9914191912590011, 0.9913905218258715, 0.9913583339607497,
                                       0.9913225961204966, 0.9912832671321499, 0.9912402960576856, 0.9911936219906240, 0.9911431737828990, 0.9910888696994810,
                                       0.9910306169972894, 0.9909683114239041, 0.9909018366304913, 0.9908310634921467, 0.9907558493275227, 0.9906760370080955,
                                       0.9905914539457294, 0.9905019109452362, 0.9904072009063883, 0.9903070973572380, 0.9902013527975631, 0.9900896968277136,
                                       0.9899718340339569, 0.9898474415964779, 0.9897161665803526, 0.9895776228628198, 0.9894313876418468, 0.9892769974609422,
                                       0.9891139436730952, 0.9889416672520418, 0.9887595528412437, 0.9885669219091597, 0.9883630248526034, 0.9881470318569457,
                                       0.9879180222809051, 0.9876749722825310, 0.9874167403388364, 0.9871420502305995, 0.9868494709610887, 0.9865373929461655,
                                       0.9862039996442390, 0.9858472335755389, 0.9854647553940900, 0.9850538942989907, 0.9846115875710347, 0.9841343063494573,
                                       0.9836179638544746, 0.9830578010168337, 0.9824482427525728, 0.9817827157061126, 0.9810534148544756, 0.9802510014227667,
                                       0.9793642073274506, 0.9783793105963312, 0.9772794298852922, 0.9760435609386315, 0.9746452378300764, 0.9730506368752245,
                                       0.9712158326862985, 0.9690827290502092, 0.9665728537853818, 0.9635775863118795, 0.9599421765659010, 0.9554384188286962,
                                       0.9497153478809163, 0.9422042060159378, 0.9319193267489506, 0.9169927970716931, 0.8934105197245976, 0.8507165493794344,
                                       0.7504610213889943, 0.0000000000000000 };

    GaussianZiggurat::GaussianZiggurat(SharedPointer<Rng32Bits> rng):
        _rng(rng), _uniform(RealUniform32(rng))
    {}

    Real GaussianZiggurat::next_gaussian()
    {
        for (;;)
        {
            Real   u = -0.1 + 3.0 * _uniform.next_uniform();
            uint32_t i = _rng->next() & 0x7F;

            if (i == 0)
            {
                Real x, y;
        
                do 
                {
                    x = std::log(_uniform.next_uniform()) / tail_thredshold;
                    y = std::log(_uniform.next_uniform());
                } 
                while (-2.0 * y > x * x);

                return (u < 0.0) ? (x - tail_thredshold) : (tail_thredshold - x);
            }

            Real z = u * ziggurat_x[i];

            if (std::fabs(u) < ziggurat_r[i])
                return z;

            Real z_sqr = z * z;
            Real f0 = std::exp(-0.5 * (ziggurat_x[i] * ziggurat_x[i] - z_sqr));
            Real f1 = std::exp(-0.5 * (ziggurat_x[i + 1] * ziggurat_x[i + 1] - z_sqr));

            if (_uniform.next_uniform() * (f0 - f1) + f1 < 1.0)
                return z;
        }
    }
}